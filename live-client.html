<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ® Stardew Valley Live - Client Side OAuth</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Stili per il pannello streaming */
        .streaming-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 15px;
            color: white;
            font-family: Arial, sans-serif;
            z-index: 10000;
            min-width: 320px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .platform-auth {
            margin: 10px 0;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            border: 2px solid transparent;
        }
        
        .platform-auth.connected {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }
        
        .auth-button {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .auth-button.connected {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
        }
        
        .stream-button {
            background: linear-gradient(135deg, #9C27B0, #E91E63);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin: 10px 0;
        }
        
        .stream-button:hover {
            transform: scale(1.05);
        }
        
        .stream-button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .demo-mode-banner {
            background: linear-gradient(135deg, #FF9800, #FF5722);
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
            font-size: 12px;
        }
        
        .config-missing {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
            font-size: 12px;
        }
        
        .toggle-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10001;
            font-size: 20px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-offline { background: #f44336; }
        .status-connecting { background: #ff9800; }
        .status-live { background: #4caf50; }
        
        .viewer-count {
            background: rgba(0,0,0,0.3);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <!-- Toggle pannello -->
    <button class="toggle-panel" onclick="toggleStreamingPanel()" title="Toggle Streaming Panel">
        ğŸ¥
    </button>
    
    <!-- Pannello Streaming -->
    <div class="streaming-panel" id="streaming-panel">
        <h3 style="margin-top: 0; text-align: center;">ğŸ® Live Stream Hub</h3>
        
        <!-- Banner modalitÃ  demo o errore config -->
        <div id="mode-banner" style="display: none;"></div>
        
        <!-- Twitch Authentication -->
        <div class="platform-auth" id="twitch-auth">
            <h4>ğŸ’œ Twitch</h4>
            <div id="twitch-status">
                <span class="status-indicator status-offline"></span>
                Non collegato
            </div>
            <button class="auth-button" id="twitch-connect" onclick="connectTwitch()">
                Collega Twitch
            </button>
            <div id="twitch-info" style="display: none;">
                <div style="font-size: 12px; margin: 5px 0;">
                    Canale: <span id="twitch-channel">-</span>
                </div>
                <div class="viewer-count">
                    ğŸ‘ï¸ Spettatori: <span id="twitch-viewers">0</span>
                </div>
            </div>
        </div>
        
        <!-- TikTok Authentication -->
        <div class="platform-auth" id="tiktok-auth">
            <h4>ğŸµ TikTok</h4>
            <div id="tiktok-status">
                <span class="status-indicator status-offline"></span>
                Non collegato
            </div>
            <button class="auth-button" id="tiktok-connect" onclick="connectTikTok()">
                Collega TikTok
            </button>
            <div id="tiktok-info" style="display: none;">
                <div style="font-size: 12px; margin: 5px 0;">
                    Account: <span id="tiktok-account">-</span>
                </div>
                <div class="viewer-count">
                    ğŸ‘ï¸ Spettatori: <span id="tiktok-viewers">0</span>
                </div>
            </div>
        </div>
        
        <!-- Controlli Stream -->
        <div>
            <button class="stream-button" id="go-live-btn" onclick="goLive()" disabled>
                ğŸ”´ VAI LIVE
            </button>
            <button class="stream-button" id="stop-stream-btn" onclick="stopStream()" style="display: none;">
                â¹ï¸ FERMA STREAM
            </button>
        </div>
        
        <!-- Collegamenti rapidi -->
        <div style="margin-top: 15px;">
            <button class="auth-button" onclick="openController()" style="width: 30%;">
                ğŸ›ï¸ Controller
            </button>
            <button class="auth-button" onclick="toggleFullscreen()" style="width: 30%;">
                â›¶ Fullscreen
            </button>
            <button class="auth-button" onclick="openSetup()" style="width: 35%;">
                âš™ï¸ Setup API
            </button>
        </div>
        
        <!-- Status generale -->
        <div id="general-status" style="margin-top: 10px; font-size: 12px; text-align: center;">
            ğŸ“¡ Caricamento...
        </div>
    </div>
    
    <!-- Overlay principale (stesso di prima) -->
    <div class="overlay-container">
        <!-- Cornice principale -->
        <div class="main-frame">
            <!-- Angoli decorativi -->
            <div class="corner top-left">ğŸŒ±</div>
            <div class="corner top-right">ğŸ„</div>
            <div class="corner bottom-left">ğŸ¥•</div>
            <div class="corner bottom-right">ğŸŒ»</div>
            
            <!-- Bordi decorativi -->
            <div class="border-decoration top">
                <span class="plant-icon">ğŸŒ¿</span>
                <span class="plant-icon">ğŸ…</span>
                <span class="plant-icon">ğŸŒ½</span>
                <span class="plant-icon">ğŸ¥¬</span>
                <span class="plant-icon">ğŸŒ¶ï¸</span>
            </div>
            
            <div class="border-decoration bottom">
                <span class="plant-icon">ğŸ¥”</span>
                <span class="plant-icon">ğŸ†</span>
                <span class="plant-icon">ğŸ¥’</span>
                <span class="plant-icon">ğŸŒ°</span>
                <span class="plant-icon">ğŸ“</span>
            </div>
            
            <div class="border-decoration left">
                <span class="plant-icon vertical">ğŸŒ¸</span>
                <span class="plant-icon vertical">ğŸŒº</span>
                <span class="plant-icon vertical">ğŸŒ¼</span>
            </div>
            
            <div class="border-decoration right">
                <span class="plant-icon vertical">ğŸµï¸</span>
                <span class="plant-icon vertical">ğŸŒ·</span>
                <span class="plant-icon vertical">ğŸŒ¹</span>
            </div>
        </div>
        
        <!-- Pannello informazioni -->
        <div class="info-panel">
            <div class="info-title">ğŸ“± Info Giardino ğŸ“±</div>
            <div class="info-content">
                <div class="stat-item">
                    <span class="stat-icon">â­</span>
                    <span class="stat-text">Livello Farming</span>
                    <span class="stat-value" id="farming-level">10</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">ğŸ’°</span>
                    <span class="stat-text">Monete</span>
                    <span class="stat-value" id="coins">999,999g</span>
                </div>
                <div class="stat-item seeds-item" id="seeds-item">
                    <span class="stat-icon">ğŸŒ±</span>
                    <span class="stat-text">Semi Piantati</span>
                    <span class="stat-value" id="seeds">42</span>
                    <span class="expand-arrow">â–¼</span>
                </div>
            </div>
        </div>
        
        <!-- Sezione ricette -->
        <div class="recipe-panel">
            <div class="recipe-title" id="recipe-title">ğŸ‘©â€ğŸ³ Ricetta del Giorno ğŸ‘©â€ğŸ³</div>
            <div class="recipe-content">
                <div class="recipe-item">
                    <span class="recipe-icon" id="recipe-icon">ğŸ¥—</span>
                    <span class="recipe-name" id="recipe-name">Insalata di Stagione</span>
                </div>
                <div class="recipe-ingredients" id="recipe-ingredients">
                    <span class="ingredient" id="ingredient1">ğŸ¥¬ Lattuga</span>
                    <span class="ingredient" id="ingredient2">ğŸ… Pomodoro</span>
                    <span class="ingredient" id="ingredient3">ğŸ¥’ Cetriolo</span>
                </div>
            </div>
        </div>
        
        <!-- Notifiche animate -->
        <div class="notification-area">
            <div class="notification hidden" id="follow-notification">
                <span class="notif-icon">ğŸ‰</span>
                <span class="notif-text" id="notification-text">Nuovo Follower!</span>
                <span class="notif-icon">ğŸŒŸ</span>
            </div>
        </div>
        
        <!-- Decorazioni fluttuanti -->
        <div class="floating-decorations">
            <div class="floating-item" style="--delay: 0s; --x: 10%;">ğŸ¦‹</div>
            <div class="floating-item" style="--delay: 2s; --x: 70%;">ğŸ</div>
            <div class="floating-item" style="--delay: 4s; --x: 40%;">ğŸƒ</div>
            <div class="floating-item" style="--delay: 6s; --x: 80%;">âœ¨</div>
            <div class="floating-item" style="--delay: 8s; --x: 20%;">ğŸŒ¸</div>
        </div>
        
        <!-- Barra del tempo -->
        <div class="weather-bar">
            <div class="weather-item">
                <span class="weather-icon" id="weather-icon">â˜€ï¸</span>
                <span class="weather-text" id="weather-text">Primavera - Giorno 15</span>
            </div>
            <div class="weather-temp" id="weather-temp">22Â°C</div>
        </div>
    </div>
    
    <script src="main.js"></script>
    <script src="configurator.js"></script>
    <script>
        console.log('ğŸ® Client-Side Live Platform inizializzata');
        
        let streamingConfig = null;
        let twitchAuth = null;
        let tiktokAuth = null;
        let streamActive = false;
        let mediaStream = null;
        
        // Carica configurazione
        function loadStreamingConfig() {
            const config = localStorage.getItem('streaming_config');
            if (!config) {
                showConfigMissing();
                return false;
            }
            
            streamingConfig = JSON.parse(config);
            
            if (!streamingConfig.configured) {
                showConfigMissing();
                return false;
            }
            
            if (streamingConfig.demo_mode) {
                showDemoMode();
            }
            
            return true;
        }
        
        // Mostra banner modalitÃ  demo
        function showDemoMode() {
            const banner = document.getElementById('mode-banner');
            banner.innerHTML = 'ğŸ® <strong>MODALITÃ€ DEMO</strong> - Clicca "Setup API" per configurazione reale';
            banner.className = 'demo-mode-banner';
            banner.style.display = 'block';
        }
        
        // Mostra banner configurazione mancante
        function showConfigMissing() {
            const banner = document.getElementById('mode-banner');
            banner.innerHTML = 'âš™ï¸ <strong>CONFIGURAZIONE RICHIESTA</strong> - Clicca "Setup API"';
            banner.className = 'config-missing';
            banner.style.display = 'block';
        }
        
        // Toggle pannello
        function toggleStreamingPanel() {
            const panel = document.getElementById('streaming-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        // Connessione Twitch (client-side OAuth)
        async function connectTwitch() {
            try {
                updateStatus('ğŸ”„ Connessione a Twitch...');
                
                if (streamingConfig && streamingConfig.demo_mode) {
                    // Demo mode
                    setTimeout(() => {
                        twitchAuth = {
                            demo: true,
                            user: { display_name: 'DemoStreamer', id: 'demo123' }
                        };
                        updateTwitchStatus(true);
                        checkStreamButtonStatus();
                        updateStatus('âœ… Twitch collegato (Demo Mode)');
                    }, 2000);
                    return;
                }
                
                if (!streamingConfig || !streamingConfig.twitch) {
                    updateStatus('âŒ Configurazione Twitch mancante');
                    if (confirm('Vuoi configurare Twitch ora?')) {
                        openSetup();
                    }
                    return;
                }
                
                // OAuth diretto
                const clientId = streamingConfig.twitch.client_id;
                const redirectUri = encodeURIComponent(window.location.origin + '/auth-callback.html');
                const scopes = encodeURIComponent('channel:manage:broadcast user:read:email');
                const state = encodeURIComponent(JSON.stringify({platform: 'twitch', timestamp: Date.now()}));
                
                const authUrl = `https://id.twitch.tv/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=code&scope=${scopes}&state=${state}`;
                
                // Apri popup
                const popup = window.open(authUrl, 'twitch-auth', 'width=500,height=600');
                
                // Ascolta callback
                window.addEventListener('message', (event) => {
                    if (event.data.type === 'auth_success' && event.data.platform === 'twitch') {
                        popup.close();
                        twitchAuth = event.data;
                        updateTwitchStatus(true);
                        checkStreamButtonStatus();
                        updateStatus(`âœ… Twitch collegato: ${event.data.user.display_name}`);
                    }
                });
                
            } catch (error) {
                console.error('Errore connessione Twitch:', error);
                updateStatus('âŒ Errore connessione Twitch');
            }
        }
        
        // Connessione TikTok (client-side OAuth)
        async function connectTikTok() {
            try {
                updateStatus('ğŸ”„ Connessione a TikTok...');
                
                if (streamingConfig && streamingConfig.demo_mode) {
                    // Demo mode
                    setTimeout(() => {
                        tiktokAuth = {
                            demo: true,
                            user: { display_name: 'DemoTikToker', open_id: 'demo456' }
                        };
                        updateTikTokStatus(true);
                        checkStreamButtonStatus();
                        updateStatus('âœ… TikTok collegato (Demo Mode)');
                    }, 2000);
                    return;
                }
                
                if (!streamingConfig || !streamingConfig.tiktok) {
                    updateStatus('âŒ Configurazione TikTok mancante');
                    if (confirm('Vuoi configurare TikTok ora?')) {
                        openSetup();
                    }
                    return;
                }
                
                // OAuth diretto
                const clientKey = streamingConfig.tiktok.client_key;
                const redirectUri = encodeURIComponent(window.location.origin + '/auth-callback.html');
                const scopes = encodeURIComponent('user.info.basic');
                const state = encodeURIComponent(JSON.stringify({platform: 'tiktok', timestamp: Date.now()}));
                
                const authUrl = `https://www.tiktok.com/v2/auth/authorize/?client_key=${clientKey}&redirect_uri=${redirectUri}&response_type=code&scope=${scopes}&state=${state}`;
                
                // Apri popup
                const popup = window.open(authUrl, 'tiktok-auth', 'width=500,height=600');
                
                // Ascolta callback
                window.addEventListener('message', (event) => {
                    if (event.data.type === 'auth_success' && event.data.platform === 'tiktok') {
                        popup.close();
                        tiktokAuth = event.data;
                        updateTikTokStatus(true);
                        checkStreamButtonStatus();
                        updateStatus(`âœ… TikTok collegato: ${event.data.user.display_name}`);
                    }
                });
                
            } catch (error) {
                console.error('Errore connessione TikTok:', error);
                updateStatus('âŒ Errore connessione TikTok');
            }
        }
        
        // Vai Live
        async function goLive() {
            try {
                updateStatus('ğŸ”„ Avvio stream...');
                
                if (streamingConfig && streamingConfig.demo_mode) {
                    // Demo mode
                    streamActive = true;
                    document.getElementById('go-live-btn').style.display = 'none';
                    document.getElementById('stop-stream-btn').style.display = 'block';
                    
                    updateTwitchStatus(true, true);
                    updateTikTokStatus(true, true);
                    updateStatus('ğŸ”´ LIVE (Demo Mode)');
                    startViewerCounter();
                    return;
                }
                
                // Richiedi webcam
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720 },
                    audio: true
                });
                
                streamActive = true;
                document.getElementById('go-live-btn').style.display = 'none';
                document.getElementById('stop-stream-btn').style.display = 'block';
                
                if (twitchAuth) updateTwitchStatus(true, true);
                if (tiktokAuth) updateTikTokStatus(true, true);
                
                updateStatus('ğŸ”´ LIVE! Stream attivo');
                startViewerCounter();
                
            } catch (error) {
                console.error('Errore avvio stream:', error);
                updateStatus('âŒ Errore: ' + error.message);
            }
        }
        
        // Ferma Stream
        function stopStream() {
            streamActive = false;
            
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            document.getElementById('go-live-btn').style.display = 'block';
            document.getElementById('stop-stream-btn').style.display = 'none';
            
            if (twitchAuth) updateTwitchStatus(true, false);
            if (tiktokAuth) updateTikTokStatus(true, false);
            
            updateStatus('â¹ï¸ Stream terminato');
        }
        
        // Aggiorna status Twitch
        function updateTwitchStatus(connected, live = false) {
            const authDiv = document.getElementById('twitch-auth');
            const statusDiv = document.getElementById('twitch-status');
            const infoDiv = document.getElementById('twitch-info');
            const button = document.getElementById('twitch-connect');
            
            if (connected) {
                authDiv.classList.add('connected');
                button.classList.add('connected');
                button.textContent = live ? 'ğŸ”´ LIVE' : 'âœ… Collegato';
                statusDiv.innerHTML = `<span class="status-indicator ${live ? 'status-live' : 'status-offline'}"></span>${live ? 'IN DIRETTA' : 'Collegato'}`;
                infoDiv.style.display = 'block';
                document.getElementById('twitch-channel').textContent = twitchAuth.user.display_name;
            }
        }
        
        // Aggiorna status TikTok
        function updateTikTokStatus(connected, live = false) {
            const authDiv = document.getElementById('tiktok-auth');
            const statusDiv = document.getElementById('tiktok-status');
            const infoDiv = document.getElementById('tiktok-info');
            const button = document.getElementById('tiktok-connect');
            
            if (connected) {
                authDiv.classList.add('connected');
                button.classList.add('connected');
                button.textContent = live ? 'ğŸ”´ LIVE' : 'âœ… Collegato';
                statusDiv.innerHTML = `<span class="status-indicator ${live ? 'status-live' : 'status-offline'}"></span>${live ? 'IN DIRETTA' : 'Collegato'}`;
                infoDiv.style.display = 'block';
                document.getElementById('tiktok-account').textContent = tiktokAuth.user.display_name;
            }
        }
        
        // Controlla pulsante stream
        function checkStreamButtonStatus() {
            const goLiveBtn = document.getElementById('go-live-btn');
            goLiveBtn.disabled = !(twitchAuth || tiktokAuth);
        }
        
        // Contatore spettatori
        function startViewerCounter() {
            setInterval(() => {
                if (streamActive) {
                    const twitchViewers = Math.floor(Math.random() * 50) + 10;
                    const tiktokViewers = Math.floor(Math.random() * 100) + 20;
                    
                    if (twitchAuth) document.getElementById('twitch-viewers').textContent = twitchViewers;
                    if (tiktokAuth) document.getElementById('tiktok-viewers').textContent = tiktokViewers;
                }
            }, 5000);
        }
        
        // Utility functions
        function updateStatus(message) {
            document.getElementById('general-status').textContent = message;
        }
        
        function openController() {
            window.open('/controllo.html', 'controller', 'width=800,height=600');
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        function openSetup() {
            window.open('/setup-streaming.html', 'setup', 'width=800,height=700');
        }
        
        // Sistema overlay
        function loadOverlayData() {
            const data = JSON.parse(localStorage.getItem('stardew-overlay-data') || '{}');
            
            if (data.seeds !== undefined) document.getElementById('seeds').textContent = data.seeds;
            if (data.coins) document.getElementById('coins').textContent = data.coins;
            if (data.farmingLevel) document.getElementById('farming-level').textContent = data.farmingLevel;
            if (data.weatherIcon) document.getElementById('weather-icon').textContent = data.weatherIcon;
            if (data.weatherText) document.getElementById('weather-text').textContent = data.weatherText;
            if (data.weatherTemp) document.getElementById('weather-temp').textContent = data.weatherTemp;
            if (data.recipeIcon) document.getElementById('recipe-icon').textContent = data.recipeIcon;
            if (data.recipeName) document.getElementById('recipe-name').textContent = data.recipeName;
            if (data.ingredient1) document.getElementById('ingredient1').textContent = data.ingredient1;
            if (data.ingredient2) document.getElementById('ingredient2').textContent = data.ingredient2;
            if (data.ingredient3) document.getElementById('ingredient3').textContent = data.ingredient3;
        }
        
        function checkNotifications() {
            const notificationData = localStorage.getItem('stardew-overlay-notification');
            if (notificationData) {
                const notification = JSON.parse(notificationData);
                const notificationElement = document.getElementById('follow-notification');
                const textElement = document.getElementById('notification-text');
                
                textElement.textContent = notification.message;
                notificationElement.classList.remove('hidden');
                
                setTimeout(() => {
                    notificationElement.classList.add('hidden');
                }, 3000);
                
                localStorage.removeItem('stardew-overlay-notification');
            }
        }
        
        // Auto-update
        setInterval(() => {
            loadOverlayData();
            checkNotifications();
        }, 2000);
        
        // Inizializzazione
        if (loadStreamingConfig()) {
            loadOverlayData();
            updateStatus('ğŸ“¡ Pronto per il collegamento');
        } else {
            updateStatus('âš™ï¸ Configurazione richiesta');
        }
        
        console.log('ğŸš€ Client-Side Platform pronta!');
    </script>
</body>
</html>